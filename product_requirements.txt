Project: Highlight & Note Extension Tech Stack: Chrome Side Panel API + IndexedDB + LangChain.js
1. Core Architecture

    Storage: IndexedDB (via a wrapper like idb-keyval or Dexie.js).

        Reason: Supports massive storage (blobs/text) and compression.

    Browser Compatibility:

        Chrome (sidePanel API).

        Firefox (sidebar_action API).

        Note: Shared logic, separate manifest.json configurations.

2. The Highlighter (Front-End) & Configuration

    Creation & Palette:

        Interaction: User selects text -> Floating Menu appears.

        Dynamic Palette: The Floating Menu displays a user-configurable set of color swatches (defined in Settings).

    On-the-Fly Editing:

        Edit Existing: Clicking an existing highlight opens a "Mini-Editor" popover allowing immediate color swapping or deletion without opening the side panel.

        Opacity Control: Users can adjust opacity globally or per-highlight to ensure text readability on dark-mode websites.

    Collision Handling (Stacks & Overlaps):

        Visuals: Newer highlights overlay older ones.

        Cluster Bubbles UI: Hovering a section with overlapping highlights displays a row of colored dots (Cluster Bubbles) above the text.

        Layer Editing:

            Hovering a specific dot in the cluster isolates that highlight.

            New Requirement: Right-clicking a dot in the cluster allows the user to change only that layer's color.

    Robust Re-attachment (Fuzzy Matching):

        Store Exact Match (text), Location (XPath), and Context (30 chars before/after).

        Logic: On page load, if exact location fails, search the DOM for the Context + Text pattern to re-anchor the highlight.

3. Note Management (Side Panel)

    Contextual Views:

        Page Mode: Displays notes only for the current active URL.

        Global Mode (New Tab): A unified list of all notes stored in IndexedDB, sorted by date (newest first).

    Global Search & Filter:

        Universal Search Bar: Filters the Global List by matching text content, anchor text, or tags.

        Tag Filtering: A dashboard view to filter the global list by specific tags.

    Deep Navigation (The "Jump" Logic):

        Behavior: Clicking a note card in Global Mode triggers a "Deep Link".

        Logic: Check if the URL is open; if so, focus it. If not, open a new tab.

        Final Step: Once the page loads, automatically scroll to and flash the specific highlighted element.

    Orphan Management:

        Notes that cannot be re-attached are flagged; users can initiate "Re-assign Mode" to fix links.

4. AI Features (Hybrid Model)

    Tier 1 (Local/Free): Use Chrome Built-in AI (Gemini Nano) for "Summarize Selection" and "Suggest Tags".

    Tier 2 (Cloud/BYOK): User provides OpenAI/Anthropic Key in Settings. Keys stored in chrome.storage.local only.

5. Data Structures (JSON Schema)

    Notes Table: Stores id, url, normalizedUrl, content (HTML/Text), and tags.

    Anchor Data: Stores text, quote, prefix, suffix, xpath, color.

    Pages Table: Metadata for the Global Dashboard (title, favicon, noteCount).

    Settings (localStorage):
    JSON

    {
      "theme": "system",
      "customPalette": ["#FFFF00", "#FF00FF", "#00FF00", "#00FFFF"], // User defined colors
      "defaultOpacity": 0.5,
      "ai": { "provider": "openai", "apiKey": "..." }
    }