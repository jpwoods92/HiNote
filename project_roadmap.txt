Phase 1: Foundation & Architecture (Weeks 1-2)

Goal: Establish the extension shell, storage engine, and side panel infrastructure.

    Repository & Build Setup:

        Initialize a Monorepo or standard structure compatible with both Chrome (Manifest V3) and Firefox.

        Set up a build tool (Vite or Webpack) to compile separate manifests: manifest.chrome.json (using sidePanel) and manifest.firefox.json (using sidebar_action).

    Manifest V3 Configuration:

        Permissions: Request sidePanel, activeTab, scripting, storage (for settings), and unlimitedStorage (for IndexedDB).

        Host Permissions: <all_urls> (required to inject highlighters on any page).

    Database Initialization (Dexie.js):

        Install Dexie.js.

        Define the schema Version 1:

            pages: Primary Key normalizedUrl.

            notes: Primary Key id (UUID), Index url.

        Implement a "Database Service" class to handle CRUD operations abstractly.

    Side Panel "Hello World":

        Create a basic React/Vue/HTML page that loads in the side panel.

        Implement the handshake: When the side panel opens, it queries the activeTab URL and displays it.

Phase 2: The Highlighter Core (Weeks 3-4)

Goal: Allow users to paint on the web page and persist the coordinates.

    Text Selection & Painting:

        Event Listener: Listen for mouseup events to detect user selection.

        Floating UI: Inject a "Tooltip" DOM element near the selection (React Portal or Shadow DOM) with color swatches.

        Rendering: Use the CSS.highlights API (if available) or standard <span> wrapping to paint the text background.

    Context Capture (Crucial Step):

        When a highlight is created, capture the Anchor Data:

            exactText: The selected string.

            prefix: 30 chars before.

            suffix: 30 chars after.

            xpath: The precise DOM path.

    Persistence:

        Save this blob to Dexie.js under the notes table.

    Re-hydration (The "Fuzzy" Logic):

        On page load, query Dexie for the current URL.

        Algorithm:

            Try xpath match first (fastest).

            If xpath fails (DOM changed), search page text for prefix + exactText + suffix.

            If that fails, search for exactText with >90% similarity (using Levenshtein distance).

            If all fail, mark as isOrphaned: true.

Phase 3: Note Management & Side Panel UI (Weeks 5-6)

Goal: Build the CRUD interface in the Side Panel.

    Note List View:

        Query Dexie for all notes matching the current tab's URL.

        Render cards showing the highlighted snippet + user note.

    Rich Text Editor:

        Implement a lightweight editor (e.g., Tiptap or Slate.js) restricted to Bold, Italic, Link.

        Auto-save: Debounce keypresses (500ms) to update IndexedDB automatically.

    Bi-directional Navigation:

        Panel to Page: Clicking a note card scrolls the webpage to the specific highlight element (element.scrollIntoView()).

        Page to Panel: Clicking a highlight on the page scrolls the Side Panel list to the corresponding note card.

    Orphan Handling UI:

        Create the "Re-link" flow: A button on orphaned notes that triggers a "listener mode" waiting for the user to select new text to repair the broken link.

Phase 4: Tagging & Global Search (Weeks 7-8)

Goal: Turn isolated notes into a knowledge base.

    Tagging System:

        UI: Add a "Chip Input" field to the Note Editor.

        Storage: Ensure tags are indexed in Dexie (notes table -> tags array) for fast lookup.

        Dashboard: Create a "Tags" view in the Side Panel to see all used tags and counts.

    Global Search:

        Implement a search bar in the Side Panel header.

        Query Logic: Search against content.text, anchor.text, and tags across all URLs in Dexie.

        Result Action: Clicking a result from a different page opens that URL in a new tab and auto-scrolls to the highlight.

Phase 5: AI Integration (Weeks 9-10)

Goal: Add "Magic" features using Hybrid AI.

    Local AI (Gemini Nano):

        Check for window.ai availability (Chrome built-in AI).

        Feature: "Summarize Highlight." Pass the highlighted text to window.ai.summarizer.summarize().

        Feature: "Auto-Tag." Pass text to the model with a prompt: "Extract 3 keywords from this text as CSV."

    Cloud AI (LangChain.js):

        Settings Page: Add input for OpenAI/Anthropic API Key.

        Security: Save key to chrome.storage.local (NOT synced).

        Feature: "Ask Note." Use LangChain to send the highlighted text + a user question to the external LLM.

    Cost Controls:

        Disable Cloud features if no key is present.

        Always default to Local AI if available and sufficient.

Phase 6: Polish, Security & Release (Weeks 11-12)

Goal: Prepare for the Web Store.

    Data Portability:

        Export: Stream IndexedDB data to a JSON file (using JSON.stringify with a blob).

        Import: Read JSON, validate schema, and bulk-add to Dexie (with "Overwrite" or "Merge" options).

    Performance Tuning:

        Implement "Virtual Scrolling" in the Side Panel if a user has >50 notes on one page.

        Ensure the "Fuzzy Matcher" runs in a Web Worker to avoid freezing the main thread during heavy page loads.

    Store Assets:

        Create screenshots, promo tiles, and write the Privacy Policy (crucial: explicitly state data is stored locally).